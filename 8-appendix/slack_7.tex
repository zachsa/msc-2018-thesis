\subsection{Slack conversation 7}
\label{appendix:slack7}
zach [11:40 AM]
Hi. In a Map query, I created a variable `key` that I would then adjust and emit several times: `function(doc) {var key = [it1, it2, it3]; var arr = ["a", "b", "c", etc]; arr.forEach(function(val) {key[1] = val; emit(key, ...)})}`. but i found that the `forEach` loop didn't work as expected. It seemed that the variable `key` was in a global scope that was shared by separate instances of the map function -i.e. all the keys emitted were the last string in `arr`. Is this supposed to be the case? (edited)

jan [11:45 AM]
@zach can you share the full map fun code in a pastie service somewhere? (donâ€™t paste here pls)

rnewson (IRC) APP [11:49 AM]
ah, I can believe that

    [11:49]
emit(key,value) simply builds an array that we return @fabsolute the end

    [11:49]
so if you're modifying a variable that you emitted, it won't work as you expect

    [11:50]
though of course in your case you're also making 'key' have a scope outside of the forEach anyway

zach [11:52 AM]
the full map function is available here: https://gist.githubusercontent.com/zachsa/52fa64fd0cc85de7b0f7fb7601aaba53/raw/ec800a79e12920f22d2d6da5d87ee020ccd44379/map%2520function

[11:53]
thank @rnewson - at the end of the map function?

rnewson (IRC) APP [11:53 AM]
after the end of the map function

    [11:54]
there's an array declared before we call your map function, any calls to emit() add items to it.

[11:54]
_if_ your function returns successfully, that array is then marshalled back to couchdb erlang side

    [11:54]
this is why an error in your map function causes none of your emits to appear in the view.

[11:54]
but also why you're seeing this effect

zach [11:58 AM]
oh ok. so per an execution of a map function, if i emit the variable 'key' several times it's just a reference to a single object - and the same for value in the case of the function (though I don't change the value variable after I emit). Thanks!

rnewson (IRC) APP [11:58 AM]
https://github.com/apache/couchdb/blob/master/share/server/views.js

[11:59]
https://github.com/apache/couchdb/blob/master/share/server/views.js#L85-L87
\section{Admission-benchmarks/Grade \% Correlation}
Correlation coefficients ($r$) between different admissions benchmarking methods and CSC1015F course results are worked out for students that are South African citizens or permanent residents, and that attended CSC1015F during their undergraduate career. Correlation is worked out on retrieval of the dataset comprising a join of admissions and grade data. In terms of SQL, such a join can be described as a \textit{left outer join} in which rows of the benchmark data are joined to rows of the grade data on the student number field; a single student may have many grade results (for example, when repeating a course) but only has a single row in the admissions data for the year in which the student first registered.

\subsection{ETL}
Using nETL, rows are extracted from the two CSV files (\textit{Admissions (2014 - 2016).csv} and \textit{Grades (2014 - 2016).csv}) independently of each other and concurrently, in batches of 5 000 and 10 000 rows respectively.

Via nETL configuration, rows from the admissions data are selected for students that are South African citizens or permanents residents, and that are undergraduates. Rows from the grades data are selected for students that attended CSC1015F during their undergraduate career. Since the admissions data doesn't have a field for course year, a natural join with grades on the \textit{anonIDnew} field is performed via nETL ($admissions \bowtie grades$) before students are selected from admissions data that attended CSC1015F.

Rows retrieved from the CSVs contain numerous fields that are not required, and so nETL is configured to apply an attribute-whitelisting process to both admissions and grade data. Batches of objects are serialized to JSON strings and loaded into a single CouchDB database via the \textit{\_bulk\_docs} endpoint. An example of a row from grade data serialized to a JSON string and as loaded into CouchDB is shown in Figure \ref{fig-json-grade}.

\input{5-analysis/figures/fig-json-grade}

\subsection{Index Calculation}
Following loading the data from the CSVs into CouchDB, a Map function is used to produce an index of the CouchDB documents ordered by Student ID, with the guarantee that for every unique student id documents are ordered by type; the demographic document precedes the Grade documents for any given student. Knowing the order of documents via the view-index allows for performing the join on data-retrieval. Only a map function is used is required (no reduce function). That is, on Map function execution the ``type\_'' attribute is checked. If the document is a line of the Grades entity, then the key [Student ID, Course, year] is emitted along with a single number for the value - the percent achieved for the course. If the document is a line of the Benchmarks entity, then the key [Student ID, 0, 0] is emitted along with an ordered list of 8 values corresponding to each of the 19 different methods of benchmarking students. This index could be achieved via the key [Student ID, year], since the course is always CSC1015F. However, it is required for testing and development purposes, so would require additional work to remove (it doesn't cost much in terms of performance overhead).

Normalization of the percentage fields (i.e. ``Percent'' for the Grades entity and the test results in the Benchmarks entity) is done via a nested function (a function defined within the map function) according to best-guess logic on how grade symbols correlate with percentage - the logic used for this is shown in Table \ref{ap-tbl-normalize-grades} and Table \ref{ap-tbl-normalize-admissions} in the appendix.

Because a student should only be represented by a single row in the admissions data and should only achieve a single grade per course per year, this 2-way join is achievable without using a reduce function. There is also no need to aggregate rows from either the admissions or grade data prior to joining. Logic of the map function is shown in the activity diagram in Figure \ref{fig-mapfn-correlation-grades}.

\input{5-analysis/figures/fig-mapfn-correlation-grades}

\subsection{Index Retrieval}
The join of admissions and grade data is performed during index retrieval via a CouchDB list function.

On invocation the CoucDB list function opens and scans the index iteratively processing each document (i.e. iteratively processing each student; first a student's demographic document is processed, then a student's grades documents are processed). The 2-way join is achieved in this way; for every student number the grade and admissions data is joined, and summations of various fields of the grades and each benchmark are updated. Once the iteration over student numbers is finished, the summations are used to calculate correlation coefficients for each grade/benchmarking method combination according to the formula\footnote{\textit{x}: grade \%, \textit{y}: benchmark (\textit{r} is calculated for multiple \textit{y} values)}: \begin{spreadlines}{15pt}
    \begin{gather*}
        \intertext{\textit{Pearson Correlation Coefficient:}}
        r = \frac{N\sum{xy} - (\sum{x})(\sum{y})}{\sqrt{[N\sum{x^2} - (\sum{x})^2][N\sum{y^2} - (\sum{y})^2]}}
    \end{gather*}
\end{spreadlines}

Although the \_stats reduce function calculates \textit{sum of squares} per dataset, this is not useful in the case where individual rows from separate entities should be joined (such as in this 2-way join). For example, in reference to working out the numerator as provided in the correlation formula: \begin{spreadlines}{15pt}
    \begin{gather*}
        N\sum{xy} - (\sum{x})(\sum{y})
    \end{gather*}
\end{spreadlines}

Using CouchDB's \_stats function only the $\sum{x}$ and $\sum{y}$ values are accessible when joining the two entities during list function execution, and not $x$ and $y$ values (similarly, the denominator of the formula could also not be calculated from \_stats function output).

The list function is configured to output a table of correlation coefficients for each benchmarking method as shown in Table \ref{tbl-correlation-grades} (but in HTML format). List function logic is represented by the activity diagram in Figure \ref{fig-listfn-correlation-grades}.

\input{5-analysis/figures/fig-listfn-correlation-grades}
\input{5-analysis/tables/tbl-correlation-grades}
\section{Admission-benchmarks/Grade \% Correlation}
Correlation coefficients ($r$) between different admissions benchmarking methods and CSC1015F course results are worked out for students that are South African citizens or permanent residents, and that attended CSC1015F during their undergraduate career. correlation is worked out on retrieval of the dataset comprising a join of admissions and grade data. In terms of SQL, such a join can be described as a \textit{left outer join} in which rows of the benchmark data are joined to rows of the grade data on the student number field; a single student may have many grade results (for example, when repeating a course) but only has a single row in the admissions data for the year in which the student first registered.

\subsection{ETL}
Using nETL, rows are extracted from the two CSV files (\textit{Admissions (2014 - 2016).csv} and \textit{Grades (2014 - 2016).csv}) independently of each other and concurrently, in batches of 5 000 and 10 000 rows respectively. Via nETL configuration, rows from the admissions data are selected for students that are South African citizens or permanents residents, and that are in undergraduate; rows from the grades data are selected for students that attended CSC1015F during their undergraduate career. A dynamic filter is applied to the admissions data to further select only students that attended CSC1015F. Batches of data from both CSVs is loaded into a single CouchDB database via the \textit{\_bulk\_docs} endpoint. A list of the transformations applied to each line extracted from each CSV is shown below:

\subsubsection{nETL Grades Transformations}
\begin{enumerate}
  \item A line is converted into a JavaScript object (which relates directly to the JSON format of CouchDB documents) with the fields:
        \begin{itemize}
          \item DownloadedDate
          \item RegAcadYear
          \item RegTerm
          \item anonIDnew
          \item RegProgram
          \item RegCareer
          \item Degree
          \item DegreeDescr
          \item Subject
          \item Catalog.
          \item Course
          \item CourseSuffix
          \item Session
          \item Percent
          \item Symbol
          \item UnitsTaken
          \item CourseID
          \item CourseDescr
          \item CourseCareer
          \item Faculty
          \item Dept
          \item MaximumCrseUnits
          \item CourseCount
          \item CourseLevel
          \item CESM
          \item Sub-CESM
        \end{itemize}
  \item Lines (now in object form) are filtered on the ``RegCareer'' and ``Course'' fields, where grades achieved for the CSC1015F course taken by students registered as undergrads are considered. Lines that don't meet this attribute are discarded and no further transformations are applied to these line
  \item An attribute (``type\_'') is then added to each line (that weren't removed in filtering step), and given the value ``grade'' to identify each object as a line of the Grade entity type
  \item Document attributes are whitelisted. The resultant documents each have the the following attributes:
        \begin{itemize}
          \item type\_
          \item Course
          \item RegAcadYear
          \item anonIDnew
          \item Percent
        \end{itemize}
\end{enumerate}

\subsubsection{nETL Benchmarks Transformations}
\begin{enumerate}
  \item A line is converted into a JavaScript object with the fields:
        \begin{itemize}
          \item anonIDnew
          \item Career
          \item Citizenship Residency
          \item SA School
          \item Eng Grd12 Fin Rslt
          \item Math Grd12 Fin Rslt
          \item Mth Lit Grd12 Fin Rslt
          \item Adv Mth Grd12 Fin Rslt
          \item Phy Sci Grd12 Fin Rslt
          \item NBT AL Score
          \item NBT QL Score
          \item NBT Math Score
          \item RegAcadYear
        \end{itemize}
  \item Lines are filtered on the ``Career'', ``Citizenship Residency'', and ``anonIDnew'' fields. Only lines for students that attended the CSC1015F course during their undergraduate career and that are either South African citizens or permanent residents are included in the result set. The list of students that attended CSC1015 is derived from the Grade data
  \item An attribute (``type\_'') is then added to each remaining line and given the value ``benchmark'' to identify each object as a line of the Benchmark entity type
  \item Attributes are whitelisted. The resultant documents each have the the following attributes:
        \begin{itemize}
          \item type\_
          \item anonIDnew
          \item Eng Grd12 Fin Rslt
          \item Math Grd12 Fin Rslt
          \item Mth Lit Grd12 Fin Rslt
          \item Adv Mth Grd12 Fin Rslt
          \item Phy Sci Grd12 Fin Rslt
          \item NBT AL Score
          \item NBT QL Score
          \item NBT Math Score
          \item RegAcadYear
        \end{itemize}
\end{enumerate}

\subsection{MapReduce}
Following loading the data from the CSVs into CouchDB, a Map function is used to produce an index of the CouchDB documents ordered by Student ID, with the guarantee that for every unique student id documents are ordered by type; the demographic document precedes the Grade documents for any given student. Knowing the order of documents via the view-index allows for performing the join on data-retrieval. Only a map function is used is required (no reduce function). Each document passed to the map function is treated according to the logic shown in the activity diagram in Figure \ref{fig-2-way-join-map-function}. That is, on Map function execution the ``type\_'' attribute is checked. If the document is a line of the Grades entity, then the key [Student ID, Course, year] is emitted along with a single number for the value - the percent achieved for the course. If the document is a line of the Benchmarks entity, then the key [student ID, 0, 0] is emitted along with an ordered list of 8 values corresponding to the different benchmarks:

\begin{itemize}
  \item Gr12 English \%
  \item Gr12 science \%
  \item Gr12 Math \%
  \item Gr 12 Math Lit \%
  \item Gr12 Adv Math \%
  \item NBT AL \%
  \item NBT QL \%
  \item NBT Math \%
\end{itemize}

Normalization of the percentage fields (i.e. ``Percent'' for the Grades entity and the test results in the Benchmarks entity) is done via a nested function within the Map function as discussed previously (Table \ref{tbl-grades-normalize} and Table \ref{tbl-benchmarks-normalize}). No reduce function is used to achieve this 2-way join. This is because, theoretically, a student should only have a single set of Benchmark results and should only achieve a single grade per course per year. As such there is no need to aggregate output from the Map function (which is done via reduction) before performing the document join via the List function.

\input{5-analysis/figures/fig-2-way-join-map-function}

\subsection{List Function}
The list function is executed via a call to CouchDB's HTTP API. For the project the URI of that function call is \url{https://localhost:5984/msc/\_design/2-way-join/\_list/2-way-join-list/ 2-way-join-view?reduce=false}. On invocation the List function opens and scans the index iteratively processing each document (i.e. iteratively processing each student; first a student's demographic document is processed, then a student's grades documents are processed). The join is performed during list function execution.

Figure \ref{fig-2-way-join-list-function} shows an activity digram representing the logic used to perform the 2-way join in the List function. The logic is wrapped in a CouchDB helper function \mintinline{text}{provides()} that accepts two arguments: the type of data the list function will emit (CSV - i.e. plain text data), and a callback that allows uses to create the data that is transformed to the output type. Within the body of the callback the variables `currentStudent', `currentYear', and `currentLine' are set to null. An iteration over the index is initiated using a while loop, with the loop invariant the result of a call to the \textit{getRow()} function. When a row exists, a check is performed on whether the Student ID of the current row is the same as the Student ID of the previous row. If not, the currentLine variable is emitted via the \textit{send()} function, and currentStudent is adjusted to be the Student ID from the current row. Then the type of row being processed is checked (i.e. whether this key:value pair was emitted from a grade or benchmark document). If from a benchmark document, the scores are added to the currentLine variable and the loop re-executes. If a Grade document, there is a check as to whether \textit{currentYear} has the same value as the Year property in the current row. If not, the \textit{currentLine} variable is emitted and \textit{currentYear} is adjusted to the new Year value and the loop re-executes. When the loop invariant becomes false the subroutine to send the currentLine is executed one last time to take into account the last document processed. \textit{currentLine} is emitted via a subroutine which first checks that the currentLine variable contains data from both the Grades and Benchmarks entity, and if not the line is discarded. Otherwise \textit{send()} is called with a comma-delimited string as a parameter, and this is emitted as output via a stay-alive network request (the connection is handled by the HTTP client). Code for the loop function is included in the appendix at \ref{2-way-join-list-function}.

\input{5-analysis/figures/fig-2-way-join-list-function}

\subsection{Output}
A sample of the resultant joined dataset is shown in Figure \ref{fig-2-way-csv-output}. The full output has 1391 rows; 350 rows for the 2014 year, 457 rows for the 2015 year, 586 rows for the 2016 year. Many student IDs are repeated for different years; this occurs when students retake the course in a subsequent year. In this case, due to the nature of the sorted view index from CouchDB, all a student's course attempts are seen as separate, sequential rows in the joined output.

\input{5-analysis/figures/fig-2-way-csv-output}
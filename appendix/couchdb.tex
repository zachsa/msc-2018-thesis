\section{MapReduce Contract}
\label{couchdb-mapreduce-contracts}
\begin{minted}{text}
/**
 * Map function
 * @param  {Object} doc Each document in the database is passed in turn to the function
 * @return {null} Nothing is returned - key:value pairs are emitted (multiple pairs can be emitted per document)
 */
function(doc) {
    emit(someKey, someValue);
};

/**
 * Reduce function (javascript implementation of the _sum function shown)
 * @param  {Object[]} [keys] A list of [key, docId] pairs - key as from the map function, and key from the original doc
 * @param  {Object[]} values Output from the map function, or from the reduce function
 * @param  {Boolean} [rereduce] Indicates whether values are output from the map (rereduce = false) or reduce (rereduce = true) function
 * @return {[type]}
 */
function(keys, values, rereduce) {
    if (rereduce) {
        return values.reduce(function(a,b) {
            return a + b;
        }, 0);
    } else {
        return values.length;
    };
};
\end{minted}

\section{Sample Design Document}
\label{couchdb-design-doc-sample}
\begin{minted}{json}
{
    "_id": "_design/sample",
    "_rev": "xxxxx",
    "language": "javascript",
    "views": {
        "view1": {
            "map": "function(doc) { ... }",
            "reduce": "function(keys, values, rereduce) { ... }"
        },
        "view2": {
            "map": "function(doc) { ... }",
            "reduce": "_stats"            
        }
    },
    "shows": {
        "show1": "function(doc, req) { ... }",
        "show2": "function(doc, req) { ... }"
    },
    "lists": {
        "listFunc1": "function(head, req) { ... };",
        "listFunc2": "function(head, req) { ... };"
    },
    "updates": {
        "update1": "function(doc, req) { ... }",
        "update2": "function(doc, req) { ... }"
    },
    "filters": {
        "filter1": "function(doc, req) { ... }",
        "filter2": "function(doc, req) { ... }"
    },
    "validate_doc_update": "function(newDoc, oldDoc, userCtx, secObj) { ... }"
}
\end{minted}

\section{Design Document Functions}
\subsection{2-Way Join}
\subsubsection{Map Function}
\label{2-way-join-map-function}
\begin{minted}{text}
function(doc) {
    /* Compound key */
    var id;
    var course;
    var year;

    /* Decision tree */
    var type = doc.type_;
    switch (type) {
        case 'grade':

            /* Key */
            id = doc.anonIDnew;
            course = doc.Course;
            year = doc.RegAcadYear;

            /* Value */
            var percent = doc.Percent || '';

            /* Normalize the percent field to a number */
            if (typeof percent !== 'number') {
                if (typeof percent !== 'string') return;
                var percentCleaned = percent.toUpperCase().trim();

                /* Return if percent is a disallowed symbol */
                if ([
                        'ATT',
                        'DE',
                        'GIP',
                        'LOA',
                        'OS',
                        'OSS',
                        'PA',
                        'SAT',
                        'UNS',
                        'AB',
                        ''
                    ].indexOf(percentCleaned) >= 0) return;

                /* Get the percentage */
                switch (percentCleaned) {
                    case 'F':
                        percent = 40;
                        break;
                    case 'DPR':
                        percent = 30;
                        break;
                    case 'INC':
                        percent = 30;
                        break;
                    case 'UF':
                        percent = 49;
                        break;
                    case 'UP':
                        percent = 45;
                        break;
                    default:
                        /* Convert percent to number */
                        percent = parseFloat(percent.substring(0, percent.length - 1));
                        if (isNaN(percent)) return;
                        break;
                };
            };

            /* Output */
            emit([id, course, year], percent);
            break;

        case 'benchmark':

            /* Key */
            id = doc.anonIDnew;
            course = 0;
            year = 0;

            /* Value (each index corresponds to a benchmark) */
            var benchmarks = [0, 0, 0, 0, 0, 0, 0, 0];

            /* Normalize symbols to numbers */
            var fuDictionary = {
                "A*": 90,
                "A": 80,
                "B": 70,
                "C": 60,
                "D": 55,
                "E": 50
            };

            function getDemographicGrade(gr) {
                var g = parseInt(gr);
                var retG;
                if (isNaN(g)) { // True for sumbols
                    if (typeof gr !== 'string') return 0;
                    retG = fuDictionary[gr.toUpperCase().trim()] || 0;
                } else {
                    retG = g;
                };
                return retG;
            };

            // Gr12 Eng
            var gEng12 = getDemographicGrade(doc["Eng Grd12 Fin Rslt"] || "");
            benchmarks[0] = gEng12;

            // Gr12 Sci
            var gSci12 = getDemographicGrade(doc["Phy Sci Grd12 Fin Rslt"] || "");
            benchmarks[1] = gSci12;

            // Gr12 Mth
            var gMth12 = getDemographicGrade(doc["Math Grd12 Fin Rslt"] || "");
            benchmarks[2] = gMth12;

            // Gr12 Mth Lit
            var gMthLit12 = getDemographicGrade(doc["Mth Lit Grd12 Fin Rslt"] || "");
            benchmarks[3] = gMthLit12;

            // Gr12 Mth Adv
            var gMthAdv12 = getDemographicGrade(doc["Adv Mth Grd12 Fin Rslt"] || "");
            benchmarks[4] = gMthAdv12;

            // NBT AL
            var gNbtAl = getDemographicGrade(doc["NBT AL Score"] || "");
            benchmarks[5] = gNbtAl;

            // NBT QL
            var gNbtQl = getDemographicGrade(doc["NBT QL Score"] || "");
            benchmarks[6] = gNbtQl;

            // NBT Mth
            var gNbtMth = getDemographicGrade(doc["NBT Math Score"] || "");
            benchmarks[7] = gNbtMth;

            /* Output */
            emit([id, course, year], benchmarks);
            break;

        default:
            break;
    };
};
\end{minted}

\subsubsection{List Function}
\label{2-way-join-list-function}
\begin{minted}{text}
function(head, req) {
    provides('csv', function() {
        /* Send the headers */
        var headers = "Year,StudentAnonID,Course,Course %,Gr12 Eng %,Gr12 Sci %,Gr12 Mth %,Gr12 Mth Lit %,Gr12 Mth Adv %,NBT AL %,NBT QL %,NBT Mth %";
        send(headers);

        /* Helper function; send current year */
        function sendLine(obj) {
            if (obj.benchmark && obj.grade) {
                var line =
                    "\n" + obj.year +
                    "," + obj.id +
                    "," + obj.course +
                    "," + obj["Course %"] +
                    "," + obj["Gr12 Eng %"] +
                    "," + obj["Gr12 Sci %"] +
                    "," + obj["Gr12 Mth %"] +
                    "," + obj["Gr12 Mth Lit %"] +
                    "," + obj["Gr12 Mth Lit %"] +
                    "," + obj["NBT AL %"] +
                    "," + obj["NBT QL %"] +
                    "," + obj["NBT Mth %"];
                send(line);
            };
        };

        /* Current function scope variables */
        var currentStudent = null;
        var currentYear = null;
        var currentLine = {};
        var key;
        var id;
        var course;
        var year;
        var value;

        /* Iterate through view results */
        while (row = getRow()) {

            /* Key */
            key = row.key;
            id = key[0];
            course = key[1];
            year = key[2];

            /* Value */
            value = row.value;

            /* Send previous line if it's a new student and then reset id */
            if (currentStudent !== id) {
                sendLine(currentLine);
                currentLine = {};
                currentStudent = id;
            };

            /* Append to/adjust current line */
            var type = (course === 0 && year === 0) ? 'benchmark' : 'grade';
            switch (type) {
                case 'benchmark':
                    currentLine.benchmark = true;
                    currentLine.id = id;
                    currentLine["Gr12 Eng %"] = value[0];
                    currentLine["Gr12 Sci %"] = value[1];
                    currentLine["Gr12 Mth %"] = value[2];
                    currentLine["Gr12 Mth Lit %"] = value[3];
                    currentLine["Gr12 Mth Adv %"] = value[4];
                    currentLine["NBT AL %"] = value[5];
                    currentLine["NBT QL %"] = value[6];
                    currentLine["NBT Mth %"] = value[7];
                    break;

                case 'grade':

                    /* Send previous line if it's a new year */
                    if (currentYear !== year) {
                        sendLine(currentLine);
                        currentYear = year;
                    };

                    currentLine.grade = true;
                    currentLine.id = id; // In case no demographic doc exists
                    currentLine.year = year;
                    currentLine.course = course;
                    currentLine["Course %"] = value[0];
                    break;

                default:
                    send({ error: "Document type unexpected" });
                    break;
            };
        };
    });
};
\end{minted}

\subsection{3-Way Join}
\subsubsection{Map Function}
\label{3-way-join-map-function}
\begin{minted}{text}
function(doc) {
    /* Compound key */
    var id;
    var course;
    var year;

    /* Decision tree */
    var type = doc.type_;
    switch (type) {
        case 'grade':
            /* Key */
            id = doc.anonIDnew;
            course = doc.Course;
            year = doc.RegAcadYear;

            /* Value */
            var percent = doc.Percent || '';

            /* Normalize the percent field to a number */
            if (typeof percent !== 'number') {
                if (typeof percent !== 'string') return;
                var percentCleaned = percent.toUpperCase().trim();

                /* Return if percent is a disallowed symbol */
                if ([
                        'ATT',
                        'DE',
                        'GIP',
                        'LOA',
                        'OS',
                        'OSS',
                        'PA',
                        'SAT',
                        'UNS',
                        'AB',
                        ''
                    ].indexOf(percentCleaned) >= 0) return;

                /* Get the percentage */
                switch (percentCleaned) {
                    case 'F':
                        percent = 40;
                        break;
                    case 'DPR':
                        percent = 30;
                        break;
                    case 'INC':
                        percent = 30;
                        break;
                    case 'UF':
                        percent = 49;
                        break;
                    case 'UP':
                        percent = 45;
                        break;
                    default:
                        /* Convert percent to number */
                        percent = parseFloat(percent.substring(0, percent.length - 1));
                        if (isNaN(percent)) return;
                        break;
                };
            };

            /* Output */
            emit([id, course, year], percent);
            break;

        case 'benchmark':
            /* Key */
            id = doc.anonIDnew;
            course = 0;
            year = 0;

            /* Value (each index corresponds to a benchmark) */
            var benchmarks = [0, 0, 0, 0, 0, 0, 0, 0];

            /* Normalize symbols to numbers */
            var fuDictionary = {
                "A*": 90,
                "A": 80,
                "B": 70,
                "C": 60,
                "D": 55,
                "E": 50
            };

            function getDemographicGrade(gr) {
                var g = parseInt(gr);
                var retG;
                if (isNaN(g)) { // True for sumbols
                    if (typeof gr !== 'string') return 0;
                    retG = fuDictionary[gr.toUpperCase().trim()] || 0;
                } else {
                    retG = g;
                };
                return retG;
            };

            // Gr12 Eng
            var gEng12 = getDemographicGrade(doc["Eng Grd12 Fin Rslt"] || "");
            benchmarks[0] = gEng12;

            // Gr12 Sci
            var gSci12 = getDemographicGrade(doc["Phy Sci Grd12 Fin Rslt"] || "");
            benchmarks[1] = gSci12;

            // Gr12 Mth
            var gMth12 = getDemographicGrade(doc["Math Grd12 Fin Rslt"] || "");
            benchmarks[2] = gMth12;

            // Gr12 Mth Lit
            var gMthLit12 = getDemographicGrade(doc["Mth Lit Grd12 Fin Rslt"] || "");
            benchmarks[3] = gMthLit12;

            // Gr12 Mth Adv
            var gMthAdv12 = getDemographicGrade(doc["Adv Mth Grd12 Fin Rslt"] || "");
            benchmarks[4] = gMthAdv12;

            // NBT AL
            var gNbtAl = getDemographicGrade(doc["NBT AL Score"] || "");
            benchmarks[5] = gNbtAl;

            // NBT QL
            var gNbtQl = getDemographicGrade(doc["NBT QL Score"] || "");
            benchmarks[6] = gNbtQl;

            // NBT Mth
            var gNbtMth = getDemographicGrade(doc["NBT Math Score"] || "");
            benchmarks[7] = gNbtMth;

            /* Output */
            emit([id, course, year], benchmarks);
            break;

        case 'event':
            var date = new Date(doc.event_date);
            var epoch = date.getTime();

            /* Key */
            id = doc.uct_id;
            course = 0;
            year = date.getFullYear();

            /* Value */
            var event = [0, 0];

            /* Midpoint =  Sunday, July 17, 2016 10:00:00 PM */
            var midDate = 1468792800000
            var semester = (epoch - midDate >= 0) ? 2 : 1;
            if (semester === 1) {
                event[0] = 1;
            } else {
                event[1] = 1;
            };

            /* Output */
            emit([id, course, year], event);
            break;

        default:
            break;
    };
};
\end{minted}

\subsubsection{List Function}
\label{3-way-join-list-function}
\begin{minted}{text}
function(head, req) {
    provides('csv', function() {
        /* Send the headers */
        var headers = "Year,StudentAnonID,Course,Course %,Gr12 Eng %,Gr12 Sci %,Gr12 Mth %,Gr12 Mth Lit %,Gr12 Mth Adv %,NBT AL %,NBT QL %,NBT Mth %,S1 Events, S2 Events";
        send(headers);

        /* Helper function; send current year */
        function sendLine(obj) {
            if (obj.benchmark && obj.grade) {
                var line =
                    "\n" + obj.year +
                    "," + obj.id +
                    "," + obj.course +
                    "," + obj["Course %"] +
                    "," + obj["Gr12 Eng %"] +
                    "," + obj["Gr12 Sci %"] +
                    "," + obj["Gr12 Mth %"] +
                    "," + obj["Gr12 Mth Lit %"] +
                    "," + obj["Gr12 Mth Lit %"] +
                    "," + obj["NBT AL %"] +
                    "," + obj["NBT QL %"] +
                    "," + obj["NBT Mth %"] +
                    "," + obj.S1 +
                    "," + obj.S2;
                send(line);
            };
        };

        /* Current function scope variables */
        var currentStudent = null;
        var currentYear = null;
        var currentLine = {};
        var key;
        var id;
        var course;
        var year;
        var value;

        /* Iterate through view results */
        while (row = getRow()) {

            /* Key */
            key = row.key;
            id = key[0];
            course = key[1];
            year = key[2];

            /* Value */
            value = row.value;

            /* Send previous line if it's a new student and then reset id */
            if (currentStudent !== id) {
                sendLine(currentLine);
                currentLine = {};
                currentStudent = id;
            };

            /* Append to/adjust current line */
            var type = (course === 0 && year === 0) ?
                'benchmark' : ((course === 0) ?
                    'event' : 'grade');

            switch (type) {
                case 'benchmark':
                    currentLine.benchmark = true;
                    currentLine.id = id;
                    currentLine["Gr12 Eng %"] = value[0];
                    currentLine["Gr12 Sci %"] = value[1];
                    currentLine["Gr12 Mth %"] = value[2];
                    currentLine["Gr12 Mth Lit %"] = value[3];
                    currentLine["Gr12 Mth Adv %"] = value[4];
                    currentLine["NBT AL %"] = value[5];
                    currentLine["NBT QL %"] = value[6];
                    currentLine["NBT Mth %"] = value[7];
                    break;

                case 'event':
                    currentLine.event = true;
                    currentLine.id = id;
                    currentLine.year = year // In case no benchmark or grade exists
                    currentLine.S1 = value[0];
                    currentLine.S2 = value[1];
                    break;

                case 'grade':

                    /* Send previous line if it's a new year */
                    if (currentYear !== year) {
                        sendLine(currentLine);
                        currentYear = year;
                    };

                    currentLine.grade = true;
                    currentLine.id = id; // In case no benchmark or event exists
                    currentLine.year = year;
                    currentLine.course = course;
                    currentLine["Course %"] = value;
                    break;

                default:
                    send({ error: "Document type unexpected" });
                    break;
            };
        };
    });
};
\end{minted}
\section{CouchDB Map and List Function}
\label{Map-List-tests}
\begin{minted}{javascript}
'use strict';
const path = require('path');
const fs = require('fs');
const assert = require('assert');

// Docs
const docs = [
    // benchmarks
    { "anonIDnew": 2448646, "Eng Grd12 Fin Rslt": 82, "Math Grd12 Fin Rslt": 94, "Mth Lit Grd12 Fin Rslt": "", "Adv Mth Grd12 Fin Rslt": "", "Phy Sci Grd12 Fin Rslt": 96, "NBT AL Score": 64, "NBT QL Score": 72, "NBT Math Score": 86, "RegAcadYear": 2016, "type_": "benchmark" },

    // events
    // { "event_date": "2016-04-15T07:53:19.000Z", "event_id": 281, "uct_id": 2448649, "site_key": 20627, "type_": "event" },

    // grades
    { "RegAcadYear": 2016, "anonIDnew": 2448646, "Course": "CSC1015F", "Percent": "F", "type_": "grade" },
    { "RegAcadYear": 2014, "anonIDnew": 2448647, "Course": "CSC1015F", "Percent": "DPR", "type_": "grade" },
    { "RegAcadYear": 2014, "anonIDnew": 2448648, "Course": "CSC1015F", "Percent": "INC", "type_": "grade" },
    { "RegAcadYear": 2014, "anonIDnew": 2448649, "Course": "CSC1015F", "Percent": "UF", "type_": "grade" },
    { "RegAcadYear": 2014, "anonIDnew": 2448650, "Course": "CSC1015F", "Percent": "UP", "type_": "grade" },
    { "RegAcadYear": 2014, "anonIDnew": 2448651, "Course": "CSC1015F", "Percent": 99, "type_": "grade" },
    { "RegAcadYear": 2014, "anonIDnew": 2448652, "Course": "CSC1015F", "Percent": "OS", "type_": "grade" }
];

// Load CouchDB functions into environment
const maps = {};
const lists = {};
eval(`maps["2-way"] = ${fs.readFileSync(__dirname + '/../two-way-join/views/2-way-join.csv/map.js')}`);
eval(`maps["3-way"] = ${fs.readFileSync(__dirname + '/../three-way-join/views/3-way-join.csv/map.js')}`);
eval(`lists["2-way"] = ${fs.readFileSync(__dirname + '/../two-way-join/lists/2-way-join.js')}`);
eval(`lists["3-way"] = ${fs.readFileSync(__dirname + '/../three-way-join/lists/3-way-join.js')}`);

/* Hold results emitted by Map function (reset by each test) */
var mappedDocs;

/* Emulate the 'emit' function provided by CouchDB */
function emit(v1, v2) {
    mappedDocs.push([v1, v2]);
};

/* Emulate CouchDB provides function */
function provides(str, cb) { cb(); }

/* Hold results emitted by List function (reset by each test) */
var listResuts;

/* Emulate the 'send' function provided by CouchDB */
function send(str) {
    listResuts.push(str);
};

/* Emulate the 'getRow' function provided by CouchDB */
const iterator = (function*() {
    var i = 0;
    while (docs[i]) {
        yield docs[i];
        i++;
    };
})();

function getRow() {
    var currentRow = iterator.next();
    if (currentRow.done) {
        return false;
    } else {
        mappedDocs = [];
        maps["2-way"](currentRow.value);
        if (mappedDocs[0]) return { key: mappedDocs[0][0], value: mappedDocs[0][1] }
    };
};

/* Do tests */
describe('2-Way Join:', function() {
    describe('Map Function', function() {
        mappedDocs = [];
        docs.forEach(function(doc, i) {
            maps["2-way"](doc);
        });
        it("Emits the correct keys for grade and benchmark docs", function() {
            assert.deepEqual(mappedDocs[0][0], [2448646, 0, 0]);
            assert.deepEqual(mappedDocs[1][0], [2448646, 'CSC1015F', 2016]);
            assert.deepEqual(mappedDocs[2][0], [2448647, 'CSC1015F', 2014]);
        });
        it("Translates grades to numbers correctly", function() {
            assert.deepEqual(mappedDocs[0][1], [82, 96, 94, 0, 0, 64, 72, 86]);
            assert.equal(mappedDocs[2][1], 30);
            assert.equal(mappedDocs[3][1], 30);
            assert.equal(mappedDocs[4][1], 49);
            assert.equal(mappedDocs[5][1], 45);
            assert.equal(mappedDocs[6][1], 99);
        });
        it("Doesn't emit docs for ignored symbols", function() {
            assert.equal(mappedDocs[7], undefined);
        });
    });
    describe('List Function', function() {
        listResuts = [];
        it('Run generator..', function() {
            lists["2-way"](null, null);
        });
        it('Headers should be emitted', function() {
            assert.deepEqual(listResuts[1], '\n2016,2448646,CSC1015F,40,82,96,94,0,0,64,72,86');
        });
        it('Join of student grade and benchmark should be correct', function() {
            assert.deepEqual(listResuts[1], '\n2016,2448646,CSC1015F,40,82,96,94,0,0,64,72,86');
        });
    });
});

describe('3-Way Join:', function() {
    describe('Map Function', function() {
        it("...", function() {
            mappedDocs = [];
        });
    });
    describe('List Function', function() {
        it('...', function() {

        });
    });
});
\end{minted}
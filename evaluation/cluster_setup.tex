\subsection{Cluster Setup}
CouchDB is a new animal on the database market, with development started by xxx in xxx primarily as a tool to xxx. The current release, CouchDB 2.1 has a variety of features that may finally make it feasible to replace the way technology has traditionally been used in workplace roles. A summary of CouchDB's key features is:

\begin{enumerate}
    \item Semi-structured data storage allows for easier use by people without prior database experience
    \item An HTTP interface effectively brings database communication out of the stone age and makes interacting with a database on a low level accessible to anyone who can code a line of JavaScript
    \item A MapReduce-based query engine allows for easily creating indexes that can be calculated via distributed computing
    \item And very easy/cheap cluster setup when compared to traditional DBMSs
\end{enumerate}

With these benefits in mind, this project explores the usage of CouchDB as a persistent (but temporary) dispersed data-processing engine for student data in the form of:

\begin{enumerate}
    \item A tool for easily configuring CouchDB clusters with enough nodes to handle the required data volume
    \item An approach for easily designing CouchDB MapReduce indexes, implementing them and running them
\end{enumerate}

CouchDB is open-source software with free binary distributions for a Windows, Max, and Linux environment. With the intent of clustering many server instances, each with it's own instance of the CouchDB software, only Linux is feasible since it is released as free software (GPL license). Combined with affordable, virtual, managed servers such as those offered by Digital Ocean, AWS, Hetzer, Linode to name a few (including several South Africa-based companies), clustered computing is very much within the reach of everyday consumers. Setting up several Ubuntu Xenial/CouchDB 2.1 instances is no more complicated than running a few commands on a Linux terminal. While there is still some technical understanding required in terms of security, it would be fairly straightforward to package 'setup' scripts for non-technical users giving users the potential to utilize CouchDB clusters in their own right.

For the purposes of this MSc, several instances of Hetzner's CX20 virtual cloud servers were used. xxx

A complete list of the commands required for a basic installation of an Ubuntu Xenial server supporting a CouchDB 2.1 installation is as follows:

\begin{minted}{sh}
# Set hostname of server
hostname <hostname>; rm /etc/hostname; touch /etc/hostname; echo <hostname> >> /etc/hostname; chmod 466 /etc/hostname;

## Install basic tooling 
# GCC collection (GNU make and GNU compiler tools)
apt-get update
apt-get install build-essential -y

# Update openssl to 1.0.2l
cd /usr/src
wget https://www.openssl.org/source/openssl-1.0.2l.tar.gz
tar -zxf openssl-1.0.2l.tar.gz
cd openssl-1.0.2l
./config
make
make test
make install
mv /usr/bin/openssl /root/
ln -s /usr/local/ssl/bin/openssl /usr/bin/openssl

# Python
apt-get update
apt-get install python -y

# libcurl
apt-get update
apt-get install libcurl4-openssl-dev -y

# ICU
apt-get update
apt-get install libicu-dev -y

# (Optional - this enables automated installations) preseed debconf to answer CouchDB installation wizard automatically
debconf-set-selections <<< 'couchdb couchdb/bindaddress string 0.0.0.0'
debconf-set-selections <<< 'couchdb couchdb/cookie string monster'
debconf-set-selections <<< 'couchdb couchdb/mode string clustered'
debconf-set-selections <<< 'couchdb couchdb/nodename string couchdb@<hostname>'
debconf-set-selections <<< 'couchdb couchdb/adminpass password <password>'
debconf-set-selections <<< 'couchdb couchdb/adminpass_again password <password>'

# register CouchDB package with the server package manager and install
echo 'deb https://apache.bintray.com/couchdb-deb xenial main' | sudo tee -a /etc/apt/sources.list
curl -L https://couchdb.apache.org/repo/bintray-pubkey.asc | sudo apt-key add -
apt-get update
apt-get install couchdb -y
\end{minted}

And then once those commands have been run to setup all the CouchDB nodes, the CouchDB cluster can be configured using a few commands on any one of the nodes (the coOrdinatingNodeHost):

\begin{minted}{sh}
# Run these two lines to add a node to the CouchDB cluster
curl -X POST -H \"Content-Type: application/json\" http://<username>:<password>@<CoOrdinatingNodeHost>:<port>/_cluster_setup -d '{\"action\": \"enable_cluster\", \"bind_address\":\"CoOrdinatingNodeHost\", \"username\": \"<username>\", \"password\":\"<password>\", \"port\": <port>, \"node_count\": \"<intented node count>\", \"remote_node\": \"<remote hostname>\", \"remote_current_user\": \"<username>\", \"remote_current_password\": \"<password>\" }'
curl -X POST -H \"Content-Type: application/json\" http://<username>:<password>@<CoOrdinatingNodeHost>:<port>/_cluster_setup -d '{\"action\": \"add_node\", \"host\":\"<remote hostname>\", \"port\": \"<port>\", \"username\": \"<username>\", \"password\":\"<password>\"}'

# Finalize the cluster setup
curl -X POST -H \"Content-Type: application/json\" http://<username>:<password>@<CoOrdinatingNodeHost>:<port>/_cluster_setup -d '{\"action\": \"finish_cluster\"}'
\end{minted}

xxx add sources for commands

In other words, installing CouchDB on Ubuntu 16.04 is not very difficult. Due to the testing requirements of this project, a Ruby script was created to automate this process and can be found at \url{https://github.com/zachsa/rcluster}. For a user, the process of installing a clustered CouchDB database now becomes a matter of adjusting a configuration object, which could be a file called 'config.json' and look like this:

\begin{minted}{json}
{
    "PrivateKey": "</path/to/id_rsa>",
    "knownHostsDir": "</path/to/known_hosts>",
    "Servers": [
        "n1.hostname.com",
        "n2.hostname.com",
        "n3.hostname.com",
    ],
    "User": "root",
    "CouchUser": "admin",
    "CouchPswd": "password",
    "CouchBindPort": 5984,
    "DBs": [{
            "name": "db1",
            "q": 8,
            "n": 3
        },
        {
            "name": "db2",
            "q": 8,
            "n": 3
        }
    ]
}
\end{minted}

And then creating a clustered database from scratch with the following command: \mintinline{ruby}{ruby init.rb}, or perhaps just double clicking on an executable in the same folder as the JSON configuration file. As virtual cloud server providers mature and add functionality, setting up clusters becomes even easier. The simple rCluster script presented in this MSc could very easily be extended to script the actual server registration as well.

For this project registering the CX20 instances required logging into the Hetzer.de website and manually ordering the 6 servers that this project utilizes. But the API available at \url{https://robot.your-server.de/doc/webservice/en.html#preface} allows for automation of the process of ordering and provisioning servers. It would not be difficult to extend the rCluster script to allow for automated server ordering. In which case, the script could easily be adjusted to setup thousands of servers at a time. i.e. CouchDB MapReduce queries could easily be dispersed among thousands of computer nodes, as could massive amounts of data. In terms of usability, and following on from the metaphor of Microsoft Excel, it would be of about equivalent difficulty to use a CouchDB cluster of 10 000 + nodes to process a dataset of several TB as it would be to do a similar analysis of a smaller amount of data on Microsoft Excel.

TODO: couchapp with MapReduce queries

\subsection{The Queries}

CouchDB uses the concept of a controller JSON document in which the server is configured. This document allows the user to write scripts that are executed on the server - including the 'map', 'reduce' and 'list' functions - the three components of querying data in CouchDB clusters that allows for mimicking what would otherwise require a RDBMS. Amongst other things, CouchDB design documents allow for:

\begin{enumerate}
    \item Specifying MapReduce query functions
    \item Specifying List/Show functions
    \item Specifying binary attachments (with referenced content type - i.e. jpeg/html/json/png/etc.etc.)
\end{enumerate}

Because attachments as defined in \_design documents can be retrieved via HTTP and can be of content type text/html, a well-known use-case of CouchDB is that it can be used to serve web content. Such webcontent falls under the category 'couchapps'. these are effectively elaborate \_design documents. Several tools exist to facilitate building couchapps. For this MSc, an open source tool available at xxx was used to allow for writing CouchDB query functions in an offline environment. The sourcecode for the 'couchapp' that is CouchDB query instructions can be found here xxx.